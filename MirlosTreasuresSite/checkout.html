<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout · Mirlos Treasures</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="index.html">
        <img src="images/mirloslogoclear.png" alt="Mirlos Treasures logo" />
        <span>Mirlos Treasures</span>
      </a>
      <div class="actions" style="margin-left:auto">
        <a href="#cart" class="cart" id="openCart">Cart <span class="badge" id="cartCount">0</span></a>
      </div>
    </div>
  </header>

  <main class="checkout-wrap container">
    <div class="checkout-head">
      <h1>Checkout</h1>
      <a class="btn" href="index.html">Continue shopping</a>
    </div>

    <table aria-label="Cart summary" class="checkout-table">
      <thead>
        <tr>
          <th>Item</th>
          <th style="width:180px">Qty</th>
          <th>Price</th>
          <th>Line Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="checkoutItems"></tbody>
      <tfoot>
        <tr>
          <td colspan="3" class="right">Subtotal</td>
          <td id="checkoutSubtotal">$0.00</td>
          <td></td>
        </tr>
        <tr>
          <td colspan="3" class="right">
            Tax
            <small class="muted block">
              Est. at <input id="taxRate" type="number" min="0" step="0.0001" value="0.0825" style="width:90px"> rate
            </small>
          </td>
          <td id="checkoutTax">$0.00</td>
          <td></td>
        </tr>
        <tr>
          <td colspan="3" class="right"><strong>Total</strong></td>
          <td id="checkoutTotal"><strong>$0.00</strong></td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <div class="actions stack-right">
      <button class="btn btn-primary place-order" id="placeOrder" type="button">Place Order (Demo)</button>
      <div id="paypal-button-container" class="paypal-container"></div>
      <div id="orderMsg" class="msg"></div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <div class="footer-brand">
        <img class="footer-logo" src="images/mirloslogoclear.png" alt="Mirlos Treasures logo" />
        <p>Curated vintage, modern craftsmanship.</p>
      </div>
      <div class="footer-bottom">
        <small>© <span id="year"></span> Mirlos Treasures · All rights reserved</small>
      </div>
    </div>
  </footer>

  <script src="cart.js"></script>
  <script>
  (function () {
    const money = n => '$' + n.toFixed(2);
    const listEl = document.getElementById('checkoutItems');
    const subEl = document.getElementById('checkoutSubtotal');
    const taxEl = document.getElementById('checkoutTax');
    const totalEl = document.getElementById('checkoutTotal');
    const rateInput = document.getElementById('taxRate');
    const badge = document.getElementById('cartCount') || document.querySelector('.badge');

    const STOCK_KEY = 'mirlos-stock';

    function updateBadgeFromCart(cart) {
      const count = (cart||[]).reduce((s,i)=>s + Number(i.qty||0), 0);
      if (badge) badge.textContent = count;
    }

    function totalsFrom(cart){
      const subtotal = (cart||[]).reduce((s, it) => s + Number(it.price)*Number(it.qty), 0);
      const rate = Math.max(0, Number(rateInput.value || 0));
      const tax = +(subtotal * rate).toFixed(2);
      const total = +(subtotal + tax).toFixed(2);
      return { subtotal, rate, tax, total };
    }

    function render() {
      const cart = window.getCart();
      updateBadgeFromCart(cart);
      if (!cart || !cart.length) {
        listEl.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:24px;">Your cart is empty.</td></tr>`;
      } else {
        listEl.innerHTML = cart.map(it => `
          <tr data-id="${it.id}">
            <td>${it.title}</td>
            <td class="qty">
              <button type="button" class="qty-btn dec" aria-label="Decrease quantity">−</button>
              <span class="q">${it.qty}</span>
              <button type="button" class="qty-btn inc" aria-label="Increase quantity">+</button>
            </td>
            <td>${money(Number(it.price))}</td>
            <td class="line">${money(Number(it.price) * Number(it.qty))}</td>
            <td><button type="button" class="cart-remove">Remove</button></td>
          </tr>
        `).join('');
      }
      const t = totalsFrom(cart);
      subEl.textContent = money(t.subtotal);
      taxEl.textContent = money(t.tax);
      totalEl.textContent = money(t.total);
    }

    // ===== Inventory reduction on order =====
    function reduceInventoryFromCart() {
      try {
        const stock = JSON.parse(localStorage.getItem(STOCK_KEY)) || {};
        const cart = window.getCart();
        cart.forEach(it => {
          const id = it.id;
          const q  = Number(it.qty || 0);
          if (id in stock) stock[id] = Math.max(0, Number(stock[id]) - q);
        });
        localStorage.setItem(STOCK_KEY, JSON.stringify(stock));
      } catch(e) { console.warn('Could not reduce stock', e); }
    }

    document.addEventListener('click', (e) => {
      const row = e.target.closest('tr[data-id]');
      if (!row) return;
      const id = row.getAttribute('data-id');
      let cart = window.getCart();

      if (e.target.closest('.qty-btn.inc')) {
        cart = cart.map(it => it.id === id ? {...it, qty: it.qty + 1} : it);
        window.setCart(cart); render(); return;
      }
      if (e.target.closest('.qty-btn.dec')) {
        cart = cart.map(it => it.id === id ? {...it, qty: Math.max(1, it.qty - 1)} : it);
        window.setCart(cart); render(); return;
      }
      if (e.target.closest('.cart-remove')) {
        cart = cart.filter(it => it.id !== id);
        window.setCart(cart); render(); return;
      }
    });

    rateInput.addEventListener('input', render);

    document.getElementById('placeOrder').addEventListener('click', () => {
      reduceInventoryFromCart();                // decrement stock (demo)
      window.setCart([]);
      render();
      window.location.href = 'success.html';
    });

    // Footer year
    document.getElementById('year').textContent = new Date().getFullYear();

    // Initial render
    render();

    // Expose totals for PayPal
    window.__getCheckoutTotals = () => totalsFrom(window.getCart());
  })();
  </script>

  <!-- PayPal Smart Buttons -->
  <script src="https://www.paypal.com/sdk/js?client-id=AedGKDV5KXNaWYJFVk4x-JPl83Yby2cnosmAKWvYKV3G045PzkHIW017AAI1Enk0IW4tOfB6BGJ5EzV2&currency=USD&components=buttons"></script>
  <script>
    paypal.Buttons({
      style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'paypal' },
      createOrder: function (data, actions) {
        const t = (typeof window.__getCheckoutTotals === 'function') ? window.__getCheckoutTotals() : { total: 0 };
        return actions.order.create({
          purchase_units: [{ amount: { value: (t.total || 0).toFixed(2) }, description: 'Mirlos Treasures Order' }]
        });
      },
      onApprove: function (data, actions) {
        return actions.order.capture().then(function () {
          // decrement stock on successful capture
          try {
            (function reduce(){
              const STOCK_KEY = 'mirlos-stock';
              const stock = JSON.parse(localStorage.getItem(STOCK_KEY)) || {};
              const cart = window.getCart();
              cart.forEach(it => {
                const id = it.id, q = Number(it.qty || 0);
                if (id in stock) stock[id] = Math.max(0, Number(stock[id]) - q);
              });
              localStorage.setItem(STOCK_KEY, JSON.stringify(stock));
            })();
          } catch (e) {}
          try { localStorage.setItem('mirlos-cart', '[]'); } catch (e) {}
          if (typeof window.setCart === 'function') window.setCart([]);
          window.location.href = 'success.html';
        });
      },
      onCancel: function () { alert('Payment cancelled.'); },
      onError: function (err) { console.error('PayPal error:', err); alert('Something went wrong.'); }
    }).render('#paypal-button-container');
  </script>
</body>
</html>
