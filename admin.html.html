<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mirlos · Product Builder</title>
  <style>
    :root{--ink:#222;--muted:#6a6258;--line:#e4dccc;--card:#fff;--bg:#faf7f1;--accent:#c08b00}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
    .wrap{width:min(1100px,92%);margin:24px auto}
    h1{margin:0 0 12px}
    .bar{display:flex;gap:10px;align-items:center;margin:10px 0 16px}
    .btn{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:#a87400}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(360px,1fr))}
    .block{position:relative;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;box-shadow:0 2px 12px rgba(0,0,0,.05)}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 4px}
    input, textarea, select{width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;background:#fffcf6}
    textarea{min-height:100px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .small{font-size:12px;color:var(--muted)}
    .preview{margin-top:10px;border:1px dashed var(--line);border-radius:10px;padding:10px;background:#fff}
    .list{white-space:pre-wrap;word-break:break-word}
    .remove-btn{
      position:absolute; top:6px; right:8px;
      background:#ff4d4d; color:#fff; border:none;
      border-radius:50%; width:22px; height:22px;
      font-size:14px; line-height:18px; cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Mirlos · Product Builder</h1>
    <div class="bar">
      <button id="add" class="btn">Add Product</button>
      <button id="generate" class="btn">Generate JSON</button>
      <button id="download" class="btn primary">Download products.json</button>
      <span id="msg" class="small"></span>
    </div>

    <div id="blocks" class="grid"></div>

    <h2>Preview</h2>
    <div class="preview">
      <div class="small">JSON (array):</div>
      <pre id="out" class="list">[]</pre>
    </div>
  </div>

  <script>
  (function(){
    const blocks = document.getElementById('blocks');
    const out    = document.getElementById('out');
    const msg    = document.getElementById('msg');

    const CATEGORY_OPTIONS = [
      ['apothecary','Apothecary'],
      ['media','Media (Cassettes/VHS)'],
      ['clothing','Clothing'],
      ['purses','Purses & Accessories'],
      ['collectibles','Collectibles'],
      ['antiques','Antiques'],
      ['toys','Toys'],
      ['beauty','Beauty & Soaps'],
      ['home','Home Decor'],
      ['electronics','Electronics']
    ];

    const slugify = s =>
      (String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'').slice(0,64))
      || ('item-'+Math.random().toString(36).slice(2,8));

    // Accept http(s), 'images/...', or bare names -> prefix 'images/'
    function sanitizeImages(raw){
      return (raw||'').split(',')
        .map(s => (s||'').trim())
        .filter(Boolean)
        .map(s => (/^https?:\/\//i).test(s) ? s : (s.startsWith('images/') ? s : 'images/'+s.replace(/^image\//i,'images/')));
    }

    function categorySelectHTML(prefill=''){
      const v = (prefill||'').toLowerCase();
      const opts = ['<option value="">— Select Category —</option>']
        .concat(CATEGORY_OPTIONS.map(([val,label]) => `<option value="${val}" ${v===val?'selected':''}>${label}</option>`));
      return `<select class="category">${opts.join('')}</select>`;
    }

    // === BLOCK TEMPLATE (includes X button) ===
    function blockHTML(prefill = {}){
      return `
        <div class="block">
          <button class="remove-btn" title="Remove this product">×</button>

          <label>Title</label>
          <input class="title" placeholder="Product title" value="${(prefill.title||'').replace(/"/g,'&quot;')}">

          <label>Category</label>
          ${categorySelectHTML(prefill.category)}

          <div class="row">
            <div>
              <label>Price</label>
              <input class="price" type="number" step="0.01" placeholder="0.00"
                     value="${typeof prefill.price==='number'?prefill.price:(prefill.price||'')}">
            </div>
            <div>
              <label>Inventory</label>
              <input class="inventory" type="number" min="0" step="1"
                     value="${prefill.inventory ?? 0}" placeholder="0">
              <div class="small" style="opacity:.75;margin-top:4px;">
                Stock: <span class="stockPreview">${prefill.inventory ?? 0}</span>
              </div>
            </div>
          </div>

          <label>Images (comma-separated)</label>
          <input class="images" placeholder="mkorange-1.jpg, mkorange-2.jpg"
                 value="${Array.isArray(prefill.images)?prefill.images.join(', '):(prefill.image||'')}">

          <label>Description</label>
          <textarea class="description" placeholder="Short description...">${prefill.description||''}</textarea>

          <div class="row">
            <div>
              <label>Condition</label>
              <select class="condition">
                <option value="">—</option>
                <option value="new" ${prefill.condition==='new'?'selected':''}>New</option>
                <option value="used" ${prefill.condition==='used'?'selected':''}>Used</option>
              </select>
            </div>
            <div>
              <label>Featured</label>
              <select class="featured">
                <option value="">No</option>
                <option value="true" ${prefill.featured?'selected':''}>Yes</option>
              </select>
            </div>
          </div>

          <div class="small" style="margin-top:8px">ID will be generated from title if omitted.</div>
        </div>
      `;
    }

    function addBlock(prefill = {}){
      const tpl = document.createElement('div');
      tpl.innerHTML = blockHTML(prefill);
      const wrap = tpl.firstElementChild;

      // X button: remove whole block
      wrap.querySelector('.remove-btn').addEventListener('click', () => {
        if (confirm('Remove this product?')) { wrap.remove(); scheduleSave(); }
      });

      // Live stock preview
      wrap.querySelector('.inventory').addEventListener('input', e => {
        const n = Number(e.target.value||0);
        wrap.querySelector('.stockPreview').textContent = Math.max(0,n);
        scheduleSave();
      });

      blocks.appendChild(wrap);
      scheduleSave();
    }

    function collectBlock(wrap){
      const title = wrap.querySelector('.title').value.trim();
      const category = (wrap.querySelector('.category').value || '').trim().toLowerCase();
      const price = Number(wrap.querySelector('.price').value || 0);
      const inventory = Number(wrap.querySelector('.inventory')?.value || 0);
      const imgs = sanitizeImages(wrap.querySelector('.images').value || '');
      const description = wrap.querySelector('.description').value.trim();
      const condition = wrap.querySelector('.condition').value;
      const featured = wrap.querySelector('.featured').value === 'true';
      const id = slugify(title);

      return {
        id, title, price, category, description, condition,
        image: imgs[0] || 'images/placeholder.png',
        images: imgs,
        featured,
        inventory
      };
    }

    // Skip empty cards so no blank objects in output
    function collectAll(){
      return Array.from(blocks.children)
        .map(collectBlock)
        .filter(p => p.title || (p.images && p.images.length));
    }

    function show(json){ out.textContent = json; }

    // Draft save/load
    function saveDraft(){
      try{ localStorage.setItem('mirlos-builder-draft', JSON.stringify(collectAll())); }catch{}
    }
    function loadDraft(){
      try{
        const raw = JSON.parse(localStorage.getItem('mirlos-builder-draft')||'[]');
        if (Array.isArray(raw) && raw.length){ raw.forEach(addBlock); }
        else { addBlock({}); }
      }catch{ addBlock({}); }
    }
    let saveTimer=null;
    function scheduleSave(){ clearTimeout(saveTimer); saveTimer=setTimeout(saveDraft,300); }

    // Actions
    document.getElementById('add').addEventListener('click', ()=> addBlock({}));

    document.getElementById('generate').addEventListener('click', ()=>{
      const list = collectAll();
      const json = JSON.stringify(list, null, 2);
      show(json);
      msg.textContent = `Generated ${list.length} product${list.length===1?'':'s'}.`;
      setTimeout(()=> msg.textContent='', 1500);
    });

    document.getElementById('download').addEventListener('click', ()=>{
      const list = collectAll();
      const json = JSON.stringify(list, null, 2);
      const blob = new Blob([json], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'products.json';
      a.click();
      URL.revokeObjectURL(a.href);
      msg.textContent = 'Downloaded products.json';
      setTimeout(()=> msg.textContent='', 1500);
    });

    loadDraft();
  })();
  </script>
</body>
</html>
